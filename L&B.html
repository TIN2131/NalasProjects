<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lexie & Abby Live Tracker âœ¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary:#6366f1; --secondary:#8b5cf6; --accent:#ec4899; --success:#10b981;
            --warning:#f59e0b; --danger:#ef4444; --dark:#1e293b; --light:#f8fafc;
            --glass:rgba(255,255,255,0.1); --glass-border:rgba(255,255,255,0.2);
        }
        body {
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; position:relative; overflow-x:hidden;
        }
        .bg-animation{position:fixed;width:100%;height:100%;top:0;left:0;z-index:-1;overflow:hidden;}
        .bg-animation::before{
            content:'';position:absolute;width:200%;height:200%;top:-50%;left:-50%;
            background:radial-gradient(circle at 20% 30%, rgba(120,119,198,.3), transparent 50%),
                       radial-gradient(circle at 80% 80%, rgba(236,72,153,.3), transparent 50%),
                       radial-gradient(circle at 40% 80%, rgba(99,102,241,.3), transparent 50%);
            animation:bgRotate 20s linear infinite;
        }
        @keyframes bgRotate{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .floating-emoji{position:fixed;font-size:2em;animation:float 15s infinite ease-in-out;z-index:-1;opacity:.3;}
        @keyframes float{
            0%,100%{transform:translateY(0) translateX(0) rotate(0)}
            25%{transform:translateY(-100px) translateX(50px) rotate(90deg)}
            50%{transform:translateY(-50px) translateX(-30px) rotate(180deg)}
            75%{transform:translateY(-150px) translateX(30px) rotate(270deg)}
        }
        .container{max-width:1400px;margin:0 auto;padding:20px;}
        .header{
            background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
            border:1px solid var(--glass-border);padding:30px;border-radius:24px;
            box-shadow:0 25px 50px -12px rgba(0,0,0,.25);margin-bottom:30px;text-align:center;position:relative;overflow:hidden;
        }
        .header::before{
            content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
            background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);
            animation:shimmer 3s infinite;
        }
        @keyframes shimmer{0%{left:-100%}100%{left:100%}}
        h1{color:white;font-size:3em;font-weight:800;margin-bottom:10px;text-shadow:0 4px 6px rgba(0,0,0,.1);letter-spacing:-1px;}
        .subtitle{color:rgba(255,255,255,.9);font-size:1.2em;font-weight:300;}
        .status-bar{display:flex;justify-content:center;gap:30px;margin-top:20px;flex-wrap:wrap;}
        .status-item{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.2);padding:8px 16px;border-radius:100px;font-size:.9em;color:white;}
        .pulse{display:inline-block;width:8px;height:8px;background:#10b981;border-radius:50%;animation:pulse 2s infinite;}
        @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(16,185,129,.7)}70%{box-shadow:0 0 0 10px rgba(16,185,129,0)}100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}}
        .control-panel{background:white;border-radius:24px;padding:30px;margin-bottom:30px;box-shadow:0 20px 40px rgba(0,0,0,.1);display:none;}
        .control-panel.admin-mode{display:block;animation:slideDown .5s ease;}
        @keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
        .control-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #f0f0f0;}
        .control-title{font-size:1.5em;color:var(--dark);font-weight:600;}
        .quick-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:25px;}
        .quick-btn{
            background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;border:none;padding:15px;border-radius:16px;
            font-size:1em;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;gap:10px;
            font-weight:500;position:relative;overflow:hidden;
        }
        .quick-btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(255,255,255,.3);border-radius:50%;transform:translate(-50%,-50%);transition:width .6s,height .6s;}
        .quick-btn:hover::before{width:300px;height:300px;}
        .quick-btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.2);}
        .quick-btn:disabled{opacity:.6;cursor:not-allowed;}
        .custom-entry{background:#f8fafc;padding:20px;border-radius:16px;margin-top:20px;}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px;}
        .form-group{display:flex;flex-direction:column;}
        .form-label{font-size:.9em;color:#64748b;margin-bottom:5px;font-weight:500;}
        .form-input,.form-select,.form-textarea{
            padding:12px;border:2px solid #e2e8f0;border-radius:12px;font-size:1em;transition:all .3s ease;background:white;
        }
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,.1);}
        .form-textarea{resize:vertical;min-height:80px;}
        .submit-btn{
            background:linear-gradient(135deg,var(--success),#059669);color:white;border:none;padding:14px 32px;font-size:1.1em;border-radius:12px;
            cursor:pointer;transition:all .3s ease;font-weight:600;display:flex;align-items:center;gap:10px;margin:20px auto 0;
        }
        .submit-btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(16,185,129,.3);}
        .submit-btn:disabled{opacity:.6;cursor:not-allowed;}
        .current-status{background:white;border-radius:24px;padding:30px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);}
        .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #f0f0f0;}
        .section-title{
            font-size:1.8em;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--secondary));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
        }
        .last-update-badge{display:flex;align-items:center;gap:8px;padding:8px 16px;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-radius:20px;font-size:.9em;color:#0369a1;font-weight:600;}
        .baby-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:25px;margin-bottom:30px;}
        .baby-card{background:linear-gradient(135deg,#fafafa,#ffffff);border-radius:20px;padding:25px;border:1px solid #e5e7eb;position:relative;overflow:hidden;transition:all .3s ease;}
        .baby-card:hover{transform:translateY(-3px);box-shadow:0 15px 30px rgba(0,0,0,.1);}
        .baby-card::before{
            content:'';position:absolute;top:0;left:0;right:0;height:4px;
            background:linear-gradient(90deg,#f59e0b,#ec4899,#8b5cf6,#3b82f6);background-size:200% 100%;animation:gradientMove 3s ease infinite;
        }
        @keyframes gradientMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        .baby-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
        .baby-name{font-size:1.8em;font-weight:700;color:var(--dark);display:flex;align-items:center;gap:10px;}
        .baby-emoji{font-size:1.2em;}
        .baby-status{padding:6px 12px;background:linear-gradient(135deg,#10b981,#059669);color:white;border-radius:20px;font-size:.85em;font-weight:600;}
        .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
        .stat-card{background:white;padding:15px;border-radius:12px;text-align:center;border:1px solid #e5e7eb;transition:all .3s ease;cursor:pointer;}
        .stat-card:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.1);border-color:var(--primary);}
        .stat-icon{font-size:2em;margin-bottom:8px;}
        .stat-label{font-size:.75em;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;}
        .stat-value{font-size:1.1em;font-weight:700;color:var(--dark);}
        .stat-time{font-size:.75em;color:#9ca3af;margin-top:2px;}
        .recent-activity{background:white;border-radius:24px;padding:30px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);}
        .activity-item{display:flex;align-items:center;gap:15px;padding:15px;background:linear-gradient(135deg,#f9fafb,#ffffff);border-radius:12px;margin-bottom:12px;border:1px solid #e5e7eb;transition:all .3s ease;}
        .activity-item:hover{transform:translateX(5px);box-shadow:0 3px 10px rgba(0,0,0,.05);}
        .activity-icon{font-size:2em;min-width:50px;text-align:center;}
        .activity-details{flex:1;}
        .activity-child{font-weight:700;color:var(--dark);font-size:1.1em;}
        .activity-text{color:#6b7280;margin-top:2px;}
        .activity-time{color:#9ca3af;font-size:.9em;text-align:right;min-width:80px;}
        .complete-log{background:white;border-radius:24px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);}
        .log-toggle{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;border:none;padding:12px 24px;border-radius:12px;font-size:1em;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .3s ease;}
        .log-toggle:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(99,102,241,.3);}
        .log-toggle.expanded{background:linear-gradient(135deg,var(--secondary),var(--primary));}
        .log-content{max-height:0;overflow:hidden;transition:max-height .5s ease;}
        .log-content.expanded{max-height:600px;overflow-y:auto;margin-top:20px;padding-right:10px;}
        .filter-tabs{display:flex;gap:10px;margin-bottom:20px;padding-top:20px;}
        .filter-tab{padding:8px 16px;background:#f1f5f9;border:none;border-radius:10px;cursor:pointer;transition:all .3s ease;font-weight:500;color:#64748b;}
        .filter-tab.active{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;}
        .log-item{display:flex;gap:15px;padding:15px;background:#f9fafb;border-radius:12px;margin-bottom:10px;border-left:4px solid;border-image:linear-gradient(135deg,var(--primary),var(--accent)) 1;transition:all .3s ease;}
        .log-item:hover{background:white;box-shadow:0 3px 10px rgba(0,0,0,.05);}
        .log-icon{font-size:1.5em;min-width:40px;text-align:center;}
        .log-details{flex:1;}
        .log-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:5px;}
        .log-child{font-weight:600;color:var(--dark);}
        .log-time{color:#9ca3af;font-size:.85em;}
        .log-activity{color:#6b7280;font-size:.95em;}
        .log-notes{color:#9ca3af;font-size:.85em;margin-top:5px;font-style:italic;}
        .log-duration{display:inline-block;padding:2px 8px;background:#fef3c7;color:#92400e;border-radius:10px;font-size:.75em;font-weight:600;margin-top:5px;}
        .mode-toggle{position:fixed;bottom:30px;right:30px;display:flex;gap:10px;z-index:1000;}
        .mode-btn{width:60px;height:60px;border-radius:50%;background:white;border:none;box-shadow:0 10px 30px rgba(0,0,0,.2);cursor:pointer;font-size:1.5em;transition:all .3s ease;display:flex;align-items:center;justify-content:center;}
        .mode-btn:hover{transform:scale(1.1);box-shadow:0 15px 35px rgba(0,0,0,.3);}
        .mode-btn.active{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;}
        .notification{position:fixed;top:30px;right:30px;background:white;padding:20px 30px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:flex;align-items:center;gap:15px;transform:translateX(400px);transition:transform .3s ease;z-index:2000;}
        .notification.show{transform:translateX(0);}
        .notification-icon{font-size:1.5em;}
        .notification-text{font-weight:600;color:var(--dark);}
        .empty-state{text-align:center;padding:40px;color:#9ca3af;}
        .empty-state-icon{font-size:3em;margin-bottom:15px;opacity:.5;}
        .loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:white;animation:spin 1s ease-in-out infinite;}
        @keyframes spin{to{transform:rotate(360deg)}}
        @media (max-width:768px){
            h1{font-size:2em;}
            .baby-cards{grid-template-columns:1fr;}
            .form-row{grid-template-columns:1fr;}
            .stats-grid{grid-template-columns:1fr;}
            .mode-toggle{bottom:20px;right:20px;}
            .mode-btn{width:50px;height:50px;font-size:1.2em;}
        }
        .log-content::-webkit-scrollbar{width:8px;}
        .log-content::-webkit-scrollbar-track{background:#f1f5f9;border-radius:10px;}
        .log-content::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--primary),var(--secondary));border-radius:10px;}
        .log-content::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,var(--secondary),var(--primary));}
    </style>
</head>
<body>
    <div class="bg-animation"></div>

    <!-- Floating emojis -->
    <div class="floating-emoji" style="top:10%;left:10%;animation-delay:0s;">ğŸ‘¶</div>
    <div class="floating-emoji" style="top:20%;right:15%;animation-delay:3s;">ğŸ¼</div>
    <div class="floating-emoji" style="bottom:30%;left:20%;animation-delay:6s;">ğŸˆ</div>
    <div class="floating-emoji" style="bottom:20%;right:10%;animation-delay:9s;">â­</div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Lexie & Abby Live Tracker âœ¨</h1>
            <p class="subtitle">Real-time updates from the best babysitters ever!</p>
            <div class="status-bar">
                <div class="status-item"><span class="pulse"></span><span>Live</span></div>
                <div class="status-item"><span>ğŸ•</span><span id="currentTime">--:--</span></div>
                <div class="status-item"><span>ğŸ”„</span><span id="lastUpdate">Never updated</span></div>
            </div>
        </div>

        <!-- Admin Control Panel -->
        <div class="control-panel" id="controlPanel">
            <div class="control-header">
                <h2 class="control-title">ğŸ® Quick Controls</h2>
                <span style="color:#94a3b8;font-size:.9em;">Admin Mode Active</span>
            </div>

            <div class="quick-actions">
                <button class="quick-btn" onclick="quickAdd('Lexie','Fed','ğŸ¼')" id="btn-lexie-fed"><span>ğŸ¼</span> Lexie Fed</button>
                <button class="quick-btn" onclick="quickAdd('Lexie','Diaper Changed','ğŸ’©')" id="btn-lexie-diaper"><span>ğŸ’©</span> Lexie Diaper</button>
                <button class="quick-btn" onclick="quickAdd('Lexie','Sleeping','ğŸ˜´')" id="btn-lexie-sleep"><span>ğŸ˜´</span> Lexie Sleep</button>
                <button class="quick-btn" onclick="quickAdd('Abby','Ate Meal','ğŸ½ï¸')" id="btn-abby-meal"><span>ğŸ½ï¸</span> Abby Ate</button>
                <button class="quick-btn" onclick="quickAdd('Abby','Used Potty','ğŸš½')" id="btn-abby-potty"><span>ğŸš½</span> Abby Potty</button>
                <button class="quick-btn" onclick="quickAdd('Abby','Sleeping','ğŸ›ï¸')" id="btn-abby-sleep"><span>ğŸ›ï¸</span> Abby Sleep</button>
                <button class="quick-btn" onclick="quickAdd('Both','Playing','ğŸ®')" id="btn-both-play"><span>ğŸ®</span> Play Time</button>
                <button class="quick-btn" onclick="quickAdd('Both','Story Time','ğŸ“š')" id="btn-both-story"><span>ğŸ“š</span> Story Time</button>
            </div>

            <div class="custom-entry">
                <h3 style="color:var(--dark);margin-bottom:20px;">ğŸ“ Custom Entry</h3>
                <form id="customForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Child</label>
                            <select class="form-select" id="childSelect">
                                <option value="Lexie">Lexie</option>
                                <option value="Abby">Abby</option>
                                <option value="Both">Both</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Activity</label>
                            <input type="text" class="form-input" id="activityInput" placeholder="e.g., Snack, Bath, Medicine">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duration (minutes)</label>
                            <input type="number" class="form-input" id="durationInput" placeholder="Optional" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="notesInput" placeholder="Any additional details..."></textarea>
                    </div>
                    <button type="submit" class="submit-btn" id="submitBtn"><span>â•</span> Add Entry</button>
                </form>
            </div>
        </div>

        <!-- Current Status Section -->
        <div class="current-status">
            <div class="section-header">
                <h2 class="section-title">ğŸ‘€ Current Status</h2>
                <div class="last-update-badge"><span>â±ï¸</span><span id="statusUpdateTime">Just now</span></div>
            </div>

            <!-- Baby Status Cards -->
            <div class="baby-cards">
                <div class="baby-card">
                    <div class="baby-header">
                        <h3 class="baby-name"><span class="baby-emoji">ğŸ‘¶</span>Lexie</h3>
                        <span class="baby-status">All Good ğŸ’š</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card" onclick="playSound('eat')">
                            <div class="stat-icon">ğŸ¼</div>
                            <div class="stat-label">Last Fed</div>
                            <div class="stat-value" id="lexie-feed-value">--</div>
                            <div class="stat-time" id="lexie-feed-time">--</div>
                        </div>
                        <div class="stat-card" onclick="playSound('sleep')">
                            <div class="stat-icon">ğŸ˜´</div>
                            <div class="stat-label">Last Sleep</div>
                            <div class="stat-value" id="lexie-sleep-value">--</div>
                            <div class="stat-time" id="lexie-sleep-time">--</div>
                        </div>
                        <div class="stat-card" onclick="playSound('diaper')">
                            <div class="stat-icon">ğŸ’©</div>
                            <div class="stat-label">Last Diaper</div>
                            <div class="stat-value" id="lexie-diaper-value">--</div>
                            <div class="stat-time" id="lexie-diaper-time">--</div>
                        </div>
                    </div>
                </div>

                <div class="baby-card">
                    <div class="baby-header">
                        <h3 class="baby-name"><span class="baby-emoji">ğŸ‘§</span>Abby</h3>
                        <span class="baby-status">Happy ğŸ˜Š</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card" onclick="playSound('eat')">
                            <div class="stat-icon">ğŸ½ï¸</div>
                            <div class="stat-label">Last Meal</div>
                            <div class="stat-value" id="abby-meal-value">--</div>
                            <div class="stat-time" id="abby-meal-time">--</div>
                        </div>
                        <div class="stat-card" onclick="playSound('sleep')">
                            <div class="stat-icon">ğŸ›ï¸</div>
                            <div class="stat-label">Last Sleep</div>
                            <div class="stat-value" id="abby-sleep-value">--</div>
                            <div class="stat-time" id="abby-sleep-time">--</div>
                        </div>
                        <div class="stat-card" onclick="playSound('potty')">
                            <div class="stat-icon">ğŸš½</div>
                            <div class="stat-label">Last Potty</div>
                            <div class="stat-value" id="abby-potty-value">--</div>
                            <div class="stat-time" id="abby-potty-time">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="recent-activity">
            <div class="section-header">
                <h2 class="section-title">âœ¨ Recent Activity</h2>
                <span style="color:#9ca3af;font-size:.9em;">Last 5 activities</span>
            </div>
            <div id="recentActivityList">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“</div>
                    <p>No activities yet</p>
                </div>
            </div>
        </div>

        <!-- Complete Log -->
        <div class="complete-log">
            <div class="section-header">
                <h2 class="section-title">ğŸ“š Complete Evening Log</h2>
                <button class="log-toggle" id="logToggle" onclick="toggleLog()">
                    <span id="logToggleIcon">â–¶</span>
                    <span id="logToggleText">Show Full Log</span>
                </button>
            </div>

            <div class="log-content" id="logContent">
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterLog('all', event)">All Activities</button>
                    <button class="filter-tab" onclick="filterLog('Lexie', event)">Lexie Only</button>
                    <button class="filter-tab" onclick="filterLog('Abby', event)">Abby Only</button>
                </div>
                <div id="logList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‚</div>
                        <p>No log entries yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mode Toggle Buttons -->
    <div class="mode-toggle">
        <button class="mode-btn" id="soundBtn" onclick="toggleSound()">ğŸ”Š</button>
        <button class="mode-btn" id="adminBtn" onclick="toggleAdminMode()">ğŸ‘¨â€ğŸ’¼</button>
        <button class="mode-btn" onclick="refreshData()">ğŸ”„</button>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span class="notification-icon">âœ…</span>
        <span class="notification-text" id="notificationText">Entry added successfully!</span>
    </div>

    <script>
        // ===== CONFIGURATION =====
        // YOUR GOOGLE SCRIPT URL (Web app deployment URL)
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzg2bu4zQIxXo5Pwk2qk1VQ2n3Gp3n_o3IyORhFFnji5J2n93KQo32D9W2fbbJaP5CzjQ/exec';

        // ===== STATE =====
        let activities = [];
        let soundEnabled = true;
        let adminMode = false;
        let logExpanded = false;
        let currentFilter = 'all';
        let isLoading = false;
        let isRefreshing = false;
        let autoRefreshId = null;
        let audioCtx = null; // lazily created

        // ===== UTIL =====
        const sleep = (ms) => new Promise(res => setTimeout(res, ms));

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function nowAmPm(date = new Date()) {
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        // Centralized API caller with timeout, retry, and CORS-safe fallback
        async function callApi(action, payload = null, { method = 'GET', timeout = 10000, retries = 1 } = {}) {
            if (!navigator.onLine) {
                const err = new Error('OFFLINE');
                err.code = 'OFFLINE';
                throw err;
            }

            const controller = new AbortController();
            const url = `${GOOGLE_SCRIPT_URL}?action=${encodeURIComponent(action)}&t=${Date.now()}`;
            const options = {
                method,
                mode: 'cors',
                cache: 'no-store',
                headers: { 'Content-Type': 'application/json' },
                signal: controller.signal,
                redirect: 'follow',
                referrerPolicy: 'no-referrer'
            };
            if (payload) options.body = JSON.stringify(payload);

            const timer = setTimeout(() => controller.abort(), timeout);

            try {
                let res;
                try {
                    res = await fetch(url, options);
                } catch (e) {
                    // If CORS/network hiccup on POST, try opaque POST then GET to verify
                    if (method === 'POST') {
                        try {
                            await fetch(url, { method: 'POST', mode: 'no-cors', body: options.body, keepalive: true });
                            // Small delay to let Apps Script write to sheet
                            await sleep(300);
                            res = await fetch(`${GOOGLE_SCRIPT_URL}?action=get&t=${Date.now()}`, { cache: 'no-store' });
                        } catch (e2) {
                            throw e2;
                        }
                    } else {
                        throw e;
                    }
                }

                // Parse as JSON (fallback to text -> JSON)
                let data;
                try {
                    data = await res.json();
                } catch {
                    const text = await res.text().catch(() => '');
                    try {
                        data = JSON.parse(text);
                    } catch {
                        const err = new Error('BAD_RESPONSE');
                        err.payload = text.slice(0, 200);
                        throw err;
                    }
                }
                return data;
            } catch (err) {
                clearTimeout(timer);
                if (retries > 0) {
                    await sleep(400);
                    return callApi(action, payload, { method, timeout, retries: retries - 1 });
                }
                throw err;
            } finally {
                clearTimeout(timer);
            }
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', () => {
            updateClock();
            setInterval(updateClock, 1000);

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true') toggleAdminMode();

            startAutoRefresh();

            document.getElementById('customForm').addEventListener('submit', (e) => {
                e.preventDefault();
                addCustomEntry();
            });

            document.addEventListener('visibilitychange', () => {
                if (document.hidden) stopAutoRefresh();
                else startAutoRefresh();
            });
        });

        function startAutoRefresh() {
            refreshData();
            stopAutoRefresh();
            autoRefreshId = setInterval(() => {
                if (!adminMode) refreshData();
            }, 10000);
        }
        function stopAutoRefresh() {
            if (autoRefreshId) clearInterval(autoRefreshId);
            autoRefreshId = null;
        }

        function updateClock() {
            document.getElementById('currentTime').textContent = nowAmPm();
        }

        function toggleAdminMode() {
            adminMode = !adminMode;
            const panel = document.getElementById('controlPanel');
            const btn = document.getElementById('adminBtn');

            if (adminMode) {
                panel.classList.add('admin-mode');
                btn.classList.add('active');
                showNotification('Admin mode activated! ğŸ®');
                // In admin mode, avoid constant polling noise; keep manual refresh
                stopAutoRefresh();
            } else {
                panel.classList.remove('admin-mode');
                btn.classList.remove('active');
                showNotification('Viewing mode activated ğŸ‘€');
                startAutoRefresh();
            }
        }

        function ensureAudio() {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } catch { /* ignore */ }
            }
            return audioCtx;
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundBtn').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
            if (soundEnabled) {
                ensureAudio();
                playSound('toggle');
            }
        }

        function toggleLog() {
            logExpanded = !logExpanded;
            const logContent = document.getElementById('logContent');
            const toggleBtn = document.getElementById('logToggle');
            const toggleIcon = document.getElementById('logToggleIcon');
            const toggleText = document.getElementById('logToggleText');

            if (logExpanded) {
                logContent.classList.add('expanded');
                toggleBtn.classList.add('expanded');
                toggleIcon.textContent = 'â–¼';
                toggleText.textContent = 'Hide Full Log';
            } else {
                logContent.classList.remove('expanded');
                toggleBtn.classList.remove('expanded');
                toggleIcon.textContent = 'â–¶';
                toggleText.textContent = 'Show Full Log';
            }
        }

        function playSound(type) {
            if (!soundEnabled || !ensureAudio()) return;

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            switch (type) {
                case 'eat':
                    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2);
                    break;
                case 'sleep':
                    oscillator.frequency.setValueAtTime(261.63, audioCtx.currentTime);
                    oscillator.frequency.setValueAtTime(329.63, audioCtx.currentTime + 0.15);
                    oscillator.frequency.setValueAtTime(196.00, audioCtx.currentTime + 0.3);
                    break;
                case 'diaper':
                case 'potty':
                    oscillator.frequency.setValueAtTime(146.83, audioCtx.currentTime);
                    oscillator.frequency.setValueAtTime(110.00, audioCtx.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(146.83, audioCtx.currentTime + 0.2);
                    break;
                case 'success':
                    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.05);
                    oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(1046.50, audioCtx.currentTime + 0.15);
                    break;
                case 'toggle':
                    oscillator.frequency.setValueAtTime(440.00, audioCtx.currentTime);
                    oscillator.frequency.setValueAtTime(880.00, audioCtx.currentTime + 0.1);
                    break;
                default:
                    oscillator.frequency.setValueAtTime(440.00, audioCtx.currentTime);
            }

            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.5);
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');

            text.textContent = message;
            notification.classList.add('show');
            playSound('success');

            setTimeout(() => { notification.classList.remove('show'); }, 3000);
        }

        async function quickAdd(child, activity, emoji) {
            if (isLoading) return;
            document.querySelectorAll('.quick-btn').forEach(btn => btn.disabled = true);

            const entry = {
                timestamp: new Date().toISOString(),
                child, activity, emoji,
                duration: null, notes: null
            };

            isLoading = true;
            try {
                const result = await callApi('add', entry, { method: 'POST', retries: 1 });
                if (result && result.success) {
                    showNotification(`${emoji} ${child}: ${activity}!`);
                    await refreshData();
                } else {
                    showNotification('âš ï¸ Failed to add activity. Please try again.');
                    console.error('Failed to add:', result);
                }
            } catch (error) {
                console.error('Error adding activity:', error);
                if (error.code === 'OFFLINE') showNotification('âš ï¸ You appear to be offline.');
                else showNotification('âš ï¸ Connection issue adding activity.');
            } finally {
                isLoading = false;
                document.querySelectorAll('.quick-btn').forEach(btn => btn.disabled = false);
            }
        }

        async function addCustomEntry() {
            if (isLoading) return;

            const child = document.getElementById('childSelect').value;
            const activity = document.getElementById('activityInput').value.trim();
            const duration = document.getElementById('durationInput').value;
            const notes = document.getElementById('notesInput').value.trim();

            if (!activity) {
                showNotification('Please enter an activity! âš ï¸');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Adding...';

            const entry = {
                timestamp: new Date().toISOString(),
                child,
                activity,
                emoji: getActivityEmoji(activity),
                duration: duration ? parseInt(duration, 10) : null,
                notes: notes || null
            };

            isLoading = true;
            try {
                const result = await callApi('add', entry, { method: 'POST', retries: 1 });
                if (result && result.success) {
                    document.getElementById('activityInput').value = '';
                    document.getElementById('durationInput').value = '';
                    document.getElementById('notesInput').value = '';
                    showNotification(`âœ… ${child}: ${activity} added!`);
                    await refreshData();
                } else {
                    showNotification('âš ï¸ Failed to add activity. Please try again.');
                    console.error('Failed to add:', result);
                }
            } catch (error) {
                console.error('Error adding activity:', error);
                if (error.code === 'OFFLINE') showNotification('âš ï¸ You appear to be offline.');
                else showNotification('âš ï¸ Connection issue adding activity.');
            } finally {
                isLoading = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>â•</span> Add Entry';
            }
        }

        function getActivityEmoji(activity) {
            const a = activity.toLowerCase();
            const map = {
                'feed':'ğŸ¼','fed':'ğŸ¼','bottle':'ğŸ¼','nurse':'ğŸ¤±',
                'eat':'ğŸ½ï¸','ate':'ğŸ½ï¸','meal':'ğŸ½ï¸','breakfast':'ğŸ¥','lunch':'ğŸ¥ª','dinner':'ğŸ',
                'snack':'ğŸª','fruit':'ğŸ','vegetable':'ğŸ¥¦',
                'sleep':'ğŸ˜´','sleeping':'ğŸ˜´','nap':'ğŸ’¤','rest':'ğŸ›ï¸','bedtime':'ğŸŒ™',
                'diaper':'ğŸ’©','poop':'ğŸ’©','pee':'ğŸ’§',
                'potty':'ğŸš½','toilet':'ğŸš½',
                'play':'ğŸ®','playing':'ğŸ®','toy':'ğŸ§¸','game':'ğŸ²',
                'story':'ğŸ“š','book':'ğŸ“–','read':'ğŸ“š',
                'bath':'ğŸ›','wash':'ğŸ§¼','shower':'ğŸš¿',
                'walk':'ğŸš¶','stroll':'ğŸ‘£','outside':'ğŸŒ³',
                'cry':'ğŸ˜­','fuss':'ğŸ˜«','upset':'ğŸ˜¢',
                'laugh':'ğŸ˜‚','smile':'ğŸ˜Š','happy':'ğŸ˜„',
                'dance':'ğŸ’ƒ','music':'ğŸµ','sing':'ğŸ¤',
                'medicine':'ğŸ’Š','vitamin':'ğŸ’Š','temperature':'ğŸŒ¡ï¸',
                'hug':'ğŸ¤—','kiss':'ğŸ˜˜','cuddle':'ğŸ¤±',
                'milestone':'ğŸ‰','achievement':'ğŸ†','first':'â­',
                'photo':'ğŸ“¸','picture':'ğŸ“·',
                'video':'ğŸ“¹','call':'ğŸ“'
            };
            for (const key in map) if (a.includes(key)) return map[key];
            return 'â­';
        }

        async function refreshData() {
            if (isRefreshing) return;
            isRefreshing = true;

            try {
                if (activities.length === 0) {
                    document.getElementById('recentActivityList').innerHTML = `
                        <div class="empty-state"><div class="empty-state-icon">â³</div>
                        <p>Loading activities...</p></div>`;
                }

                const result = await callApi('get', null, { method: 'GET', retries: 1, timeout: 12000 });

                if (result && result.success) {
                    activities = Array.isArray(result.activities) ? result.activities.slice() : [];
                    // Ensure newest first by timestamp
                    activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    document.getElementById('lastUpdate').textContent = nowAmPm();

                    if (activities.length > 0) {
                        const lastActivity = new Date(activities[0].timestamp);
                        const diff = Math.floor((Date.now() - lastActivity.getTime()) / 60000);
                        document.getElementById('statusUpdateTime').textContent =
                            diff < 1 ? 'Just now' : (diff < 60 ? `${diff} min ago` : `${Math.floor(diff / 60)}h ago`);
                    } else {
                        document.getElementById('statusUpdateTime').textContent = 'No updates yet';
                    }

                    updateBabyStats();
                    updateRecentActivities();
                    updateFullLog();
                } else {
                    console.error('Failed to fetch data:', result);
                    showNotification('âš ï¸ Unable to refresh data');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                if (activities.length === 0) {
                    document.getElementById('recentActivityList').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <p>Unable to load activities</p>
                            <p style="font-size:.9em;margin-top:10px;">${navigator.onLine ? 'Server not responding' : 'Please check your connection'}</p>
                        </div>`;
                }
            } finally {
                isRefreshing = false;
            }
        }

        function updateBabyStats() {
            const latest = {
                lexie: { feed: null, sleep: null, diaper: null },
                abby:  { meal: null, sleep: null, potty: null }
            };

            for (const activity of activities) {
                const time = new Date(activity.timestamp);
                const a = (activity.activity || '').toLowerCase();

                if ((activity.child === 'Lexie' || activity.child === 'Both')) {
                    if (!latest.lexie.feed && (a.includes('feed') || a.includes('fed') || a.includes('bottle'))) latest.lexie.feed = time;
                    if (!latest.lexie.sleep && (a.includes('sleep') || a.includes('nap'))) latest.lexie.sleep = time;
                    if (!latest.lexie.diaper && (a.includes('diaper') || a.includes('changed'))) latest.lexie.diaper = time;
                }
                if ((activity.child === 'Abby' || activity.child === 'Both')) {
                    if (!latest.abby.meal && (a.includes('eat') || a.includes('ate') || a.includes('meal') || a.includes('snack'))) latest.abby.meal = time;
                    if (!latest.abby.sleep && (a.includes('sleep') || a.includes('nap'))) latest.abby.sleep = time;
                    if (!latest.abby.potty && (a.includes('potty') || a.includes('toilet'))) latest.abby.potty = time;
                }
            }

            updateStatDisplay('lexie-feed', latest.lexie.feed);
            updateStatDisplay('lexie-sleep', latest.lexie.sleep);
            updateStatDisplay('lexie-diaper', latest.lexie.diaper);
            updateStatDisplay('abby-meal', latest.abby.meal);
            updateStatDisplay('abby-sleep', latest.abby.sleep);
            updateStatDisplay('abby-potty', latest.abby.potty);
        }

        function updateStatDisplay(statId, time) {
            const valueEl = document.getElementById(statId + '-value');
            const timeEl = document.getElementById(statId + '-time');

            if (time) {
                const diff = Math.floor((Date.now() - time.getTime()) / 60000);
                valueEl.textContent = diff < 60 ? `${diff}m ago` : `${Math.floor(diff / 60)}h ${diff % 60}m ago`;
                timeEl.textContent = nowAmPm(time);
            } else {
                valueEl.textContent = '--';
                timeEl.textContent = '--';
            }
        }

        function updateRecentActivities() {
            const container = document.getElementById('recentActivityList');
            const recent = activities.slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <p>No activities yet</p>
                    </div>`;
                return;
            }

            container.innerHTML = recent.map(activity => {
                const time = new Date(activity.timestamp);
                return `
                    <div class="activity-item">
                        <div class="activity-icon">${escapeHtml(activity.emoji || 'â­')}</div>
                        <div class="activity-details">
                            <div class="activity-child">${escapeHtml(activity.child || '')}</div>
                            <div class="activity-text">${escapeHtml(activity.activity || '')}${activity.duration ? ` (${Number(activity.duration)} min)` : ''}</div>
                        </div>
                        <div class="activity-time">${nowAmPm(time)}</div>
                    </div>`;
            }).join('');
        }

        function updateFullLog() {
            filterLog(currentFilter); // uses last-known filter
        }

        function filterLog(filter, evt) {
            currentFilter = filter;

            // Update tab styles robustly
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            if (evt && evt.target) evt.target.classList.add('active');
            else {
                // fallback: set active by text match
                const sel = Array.from(document.querySelectorAll('.filter-tab')).find(b => b.textContent.toLowerCase().includes(filter.toLowerCase()) || (filter === 'all' && b.textContent.toLowerCase().includes('all')));
                if (sel) sel.classList.add('active');
            }

            let filtered = activities;
            if (filter !== 'all') {
                filtered = activities.filter(a => a.child === filter || a.child === 'Both');
            }

            const container = document.getElementById('logList');

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‚</div>
                        <p>No ${filter === 'all' ? '' : escapeHtml(filter) + ' '}activities yet</p>
                    </div>`;
                return;
            }

            container.innerHTML = filtered.map(activity => {
                const time = new Date(activity.timestamp);
                const notes = activity.notes ? `<div class="log-notes">${escapeHtml(activity.notes)}</div>` : '';
                const dur = activity.duration ? `<span class="log-duration">â±ï¸ ${Number(activity.duration)} minutes</span>` : '';

                return `
                    <div class="log-item">
                        <div class="log-icon">${escapeHtml(activity.emoji || 'â­')}</div>
                        <div class="log-details">
                            <div class="log-header">
                                <span class="log-child">${escapeHtml(activity.child)} - ${escapeHtml(activity.activity || '')}</span>
                                <span class="log-time">${nowAmPm(time)}</span>
                            </div>
                            ${notes}
                            ${dur}
                        </div>
                    </div>`;
            }).join('');
        }
    </script>
</body>
</html>
