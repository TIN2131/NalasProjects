<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lexie & Abby Live Tracker ✨</title>
    <style>
        /* -------------------  ALL YOUR ORIGINAL CSS  ------------------- */
        * { margin:0; padding:0; box-sizing:border-box; }
        :root { --primary:#6366f1; --secondary:#8b5cf6; --accent:#ec4899; --success:#10b981; --warning:#f59e0b; --danger:#ef4444; --dark:#1e293b; --light:#f8fafc; --glass:rgba(255,255,255,0.1); --glass-border:rgba(255,255,255,0.2); }
        body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; position:relative; overflow-x:hidden; }
        .bg-animation{position:fixed;width:100%;height:100%;top:0;left:0;z-index:-1;overflow:hidden;}
        .bg-animation::before{content:'';position:absolute;width:200%;height:200%;top:-50%;left:-50%;background:radial-gradient(circle at 20% 30%,rgba(120,119,198,.3),transparent 50%),radial-gradient(circle at 80% 80%,rgba(236,72,153,.3),transparent 50%),radial-gradient(circle at 40% 80%,rgba(99,102,241,.3),transparent 50%);animation:bgRotate 20s linear infinite;}
        @keyframes bgRotate{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
        .floating-emoji{position:fixed;font-size:2em;animation:float 15s infinite ease-in-out;z-index:-1;opacity:.3;}
        @keyframes float{0%,100%{transform:translateY(0) translateX(0) rotate(0deg);}25%{transform:translateY(-100px) translateX(50px) rotate(90deg);}50%{transform:translateY(-50px) translateX(-30px) rotate(180deg);}75%{transform:translateY(-150px) translateX(30px) rotate(270deg);}}
        .container{max-width:1400px;margin:0 auto;padding:20px;}
        .header{background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--glass-border);padding:30px;border-radius:24px;box-shadow:0 25px 50px -12px rgba(0,0,0,.25);margin-bottom:30px;text-align:center;position:relative;overflow:hidden;}
        .header::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);animation:shimmer 3s infinite;}
        @keyframes shimmer{0%{left:-100%;}100%{left:100%;}}
        h1{color:#fff;font-size:3em;font-weight:800;margin-bottom:10px;text-shadow:0 4px 6px rgba(0,0,0,.1);letter-spacing:-1px;}
        .subtitle{color:rgba(255,255,255,.9);font-size:1.2em;font-weight:300;}
        .status-bar{display:flex;justify-content:center;gap:30px;margin-top:20px;flex-wrap:wrap;}
        .status-item{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.2);padding:8px 16px;border-radius:100px;font-size:.9em;color:#fff;}
        .pulse{display:inline-block;width:8px;height:8px;background:#10b981;border-radius:50%;animation:pulse 2s infinite;}
        @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(16,185,129,.7);}70%{box-shadow:0 0 0 10px rgba(16,185,129,0);}100%{box-shadow:0 0 0 0 rgba(16,185,129,0);}}
        .control-panel{background:#fff;border-radius:24px;padding:30px;margin-bottom:30px;box-shadow:0 20px 40px rgba(0,0,0,.1);display:none;}
        .control-panel.admin-mode{display:block;animation:slideDown .5s ease;}
        @keyframes slideDown{from{opacity:0;transform:translateY(-20px);}to{opacity:1;transform:translateY(0);}}
        .control-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #f0f0f0;}
        .control-title{font-size:1.5em;color:var(--dark);font-weight:600;}
        .quick-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:25px;}
        .quick-btn{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;border:none;padding:15px;border-radius:16px;font-size:1em;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;gap:10px;font-weight:500;position:relative;overflow:hidden;}
        .quick-btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(255,255,255,.3);border-radius:50%;transform:translate(-50%,-50%);transition:width .6s,height .6s;}
        .quick-btn:hover::before{width:300px;height:300px;}
        .quick-btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.2);}
        .quick-btn:disabled{opacity:.6;cursor:not-allowed;}
        .custom-entry{background:#f8fafc;padding:20px;border-radius:16px;margin-top:20px;}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px;}
        .form-group{display:flex;flex-direction:column;}
        .form-label{font-size:.9em;color:#64748b;margin-bottom:5px;font-weight:500;}
        .form-input,.form-select,.form-textarea{padding:12px;border:2px solid #e2e8f0;border-radius:12px;font-size:1em;transition:all .3s ease;background:#fff;}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,.1);}
        .form-textarea{resize:vertical;min-height:80px;}
        .submit-btn{background:linear-gradient(135deg,var(--success),#059669);color:#fff;border:none;padding:14px 32px;font-size:1.1em;border-radius:12px;cursor:pointer;transition:all .3s ease;font-weight:600;display:flex;align-items:center;gap:10px;margin:20px auto 0;}
        .submit-btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(16,185,129,.3);}
        .submit-btn:disabled{opacity:.6;cursor:not-allowed;}
        .current-status{background:#fff;border-radius:24px;padding:30px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);}
        .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #f0f0f0;}
        .section-title{font-size:1.8em;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
        .last-update-badge{display:flex;align-items:center;gap:8px;padding:8px 16px;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-radius:20px;font-size:.9em;color:#0369a1;font-weight:600;}
        .baby-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:25px;margin-bottom:30px;}
        .baby-card{background:linear-gradient(135deg,#fafafa,#fff);border-radius:20px;padding:25px;border:1px solid #e5e7eb;position:relative;overflow:hidden;transition:all .3s ease;}
        .baby-card:hover{transform:translateY(-3px);box-shadow:0 15px 30px rgba(0,0,0,.1);}
        .baby-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#f59e0b,#ec4899,#8b5cf6,#3b82f6);background-size:200% 100%;animation:gradientMove 3s ease infinite;}
        @keyframes gradientMove{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
        .baby-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
        .baby-name{font-size:1.8em;font-weight:700;color:var(--dark);display:flex;align-items:center;gap:10px;}
        .baby-emoji{font-size:1.2em;}
        .baby-status{padding:6px 12px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;border-radius:20px;font-size:.85em;font-weight:600;}
        .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
        .stat-card{background:#fff;padding:15px;border-radius:12px;text-align:center;border:1px solid #e5e7eb;transition:all .3s ease;cursor:pointer;}
        .stat-card:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.1);border-color:var(--primary);}
        .stat-icon{font-size:2em;margin-bottom:8px;}
        .stat-label{font-size:.75em;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;}
        .stat-value{font-size:1.1em;font-weight:700;color:var(--dark);}
        .stat-time{font-size:.75em;color:#9ca3af;margin-top:2px;}
        .recent-activity{background:#fff;border-radius:24px;padding:30px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);}
        .activity-item{display:flex;align-items:center;gap:15px;padding:15px;background:linear-gradient(135deg,#f9fafb,#fff);border-radius:12px;margin-bottom:12px;border:1px solid #e5e7eb;transition:all .3s ease;}
        .activity-item:hover{transform:translateX(5px);box-shadow:0 3px 10px rgba(0,0,0,.05);}
        .activity-icon{font-size:2em;min-width:50px;text-align:center;}
        .activity-details{flex:1;}
        .activity-child{font-weight:700;color:var(--dark);font-size:1.1em;}
        .activity-text{color:#6b7280;margin-top:2px;}
        .activity-time{color:#9ca3af;font-size:.9em;text-align:right;min-width:80px;}
        .complete-log{background:#fff;border-radius:24px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);}
        .log-toggle{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;border:none;padding:12px 24px;border-radius:12px;font-size:1em;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .3s ease;}
        .log-toggle:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(99,102,241,.3);}
        .log-toggle.expanded{background:linear-gradient(135deg,var(--secondary),var(--primary));}
        .log-content{max-height:0;overflow:hidden;transition:max-height .5s ease;}
        .log-content.expanded{max-height:600px;overflow-y:auto;margin-top:20px;padding-right:10px;}
        .filter-tabs{display:flex;gap:10px;margin-bottom:20px;padding-top:20px;}
        .filter-tab{padding:8px 16px;background:#f1f5f9;border:none;border-radius:10px;cursor:pointer;transition:all .3s ease;font-weight:500;color:#64748b;}
        .filter-tab.active{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;}
        .log-item{display:flex;gap:15px;padding:15px;background:#f9fafb;border-radius:12px;margin-bottom:10px;border-left:4px solid;border-image:linear-gradient(135deg,var(--primary),var(--accent)) 1;transition:all .3s ease;}
        .log-item:hover{background:#fff;box-shadow:0 3px 10px rgba(0,0,0,.05);}
        .log-icon{font-size:1.5em;min-width:40px;text-align:center;}
        .log-details{flex:1;}
        .log-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:5px;}
        .log-child{font-weight:600;color:var(--dark);}
        .log-time{color:#9ca3af;font-size:.85em;}
        .log-activity{color:#6b7280;font-size:.95em;}
        .log-notes{color:#9ca3af;font-size:.85em;margin-top:5px;font-style:italic;}
        .log-duration{display:inline-block;padding:2px 8px;background:#fef3c7;color:#92400e;border-radius:10px;font-size:.75em;font-weight:600;margin-top:5px;}
        .mode-toggle{position:fixed;bottom:30px;right:30px;display:flex;gap:10px;z-index:1000;}
        .mode-btn{width:60px;height:60px;border-radius:50%;background:#fff;border:none;box-shadow:0 10px 30px rgba(0,0,0,.2);cursor:pointer;font-size:1.5em;transition:all .3s ease;display:flex;align-items:center;justify-content:center;}
        .mode-btn:hover{transform:scale(1.1);box-shadow:0 15px 35px rgba(0,0,0,.3);}
        .mode-btn.active{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;}
        .notification{position:fixed;top:30px;right:30px;background:#fff;padding:20px 30px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:flex;align-items:center;gap:15px;transform:translateX(400px);transition:transform .3s ease;z-index:2000;}
        .notification.show{transform:translateX(0);}
        .notification-icon{font-size:1.5em;}
        .notification-text{font-weight:600;color:var(--dark);}
        .empty-state{text-align:center;padding:40px;color:#9ca3af;}
        .empty-state-icon{font-size:3em;margin-bottom:15px;opacity:.5;}
        .loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;}
        @keyframes spin{to{transform:rotate(360deg);}}
        @media (max-width:768px){
            h1{font-size:2em;}
            .baby-cards{grid-template-columns:1fr;}
            .form-row{grid-template-columns:1fr;}
            .stats-grid{grid-template-columns:1fr;}
            .mode-toggle{bottom:20px;right:20px;}
            .mode-btn{width:50px;height:50px;font-size:1.2em;}
        }
        .log-content::-webkit-scrollbar{width:8px;}
        .log-content::-webkit-scrollbar-track{background:#f1f5f9;border-radius:10px;}
        .log-content::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--primary),var(--secondary));border-radius:10px;}
        .log-content::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,var(--secondary),var(--primary));}
        /* -------------------  /CSS  ------------------- */
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="floating-emoji" style="top:10%;left:10%;animation-delay:0s;">👶</div>
    <div class="floating-emoji" style="top:20%;right:15%;animation-delay:3s;">🍼</div>
    <div class="floating-emoji" style="bottom:30%;left:20%;animation-delay:6s;">🎈</div>
    <div class="floating-emoji" style="bottom:20%;right:10%;animation-delay:9s;">⭐</div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Lexie & Abby Live Tracker ✨</h1>
            <p class="subtitle">Real-time updates from the best babysitters ever!</p>
            <div class="status-bar">
                <div class="status-item"><span class="pulse"></span><span>Live</span></div>
                <div class="status-item"><span>🕐</span><span id="currentTime">--:--</span></div>
                <div class="status-item"><span>🔄</span><span id="lastUpdate">Never updated</span></div>
            </div>
        </div>

        <!-- Admin Control Panel -->
        <div class="control-panel" id="controlPanel">
            <div class="control-header">
                <h2 class="control-title">🎮 Quick Controls</h2>
                <span style="color:#94a3b8;font-size:.9em;">Admin Mode Active</span>
            </div>
            <div class="quick-actions">
                <button class="quick-btn" onclick="quickAdd('Lexie','Fed','🍼')" id="btn-lexie-fed"><span>🍼</span> Lexie Fed</button>
                <button class="quick-btn" onclick="quickAdd('Lexie','Diaper Changed','💩')" id="btn-lexie-diaper"><span>💩</span> Lexie Diaper</button>
                <button class="quick-btn" onclick="quickAdd('Lexie','Sleeping','😴')" id="btn-lexie-sleep"><span>😴</span> Lexie Sleep</button>
                <button class="quick-btn" onclick="quickAdd('Abby','Ate Meal','🍽️')" id="btn-abby-meal"><span>🍽️</span> Abby Ate</button>
                <button class="quick-btn" onclick="quickAdd('Abby','Used Potty','🚽')" id="btn-abby-potty"><span>🚽</span> Abby Potty</button>
                <button class="quick-btn" onclick="quickAdd('Abby','Sleeping','🛏️')" id="btn-abby-sleep"><span>🛏️</span> Abby Sleep</button>
                <button class="quick-btn" onclick="quickAdd('Both','Playing','🎮')" id="btn-both-play"><span>🎮</span> Play Time</button>
                <button class="quick-btn" onclick="quickAdd('Both','Story Time','📚')" id="btn-both-story"><span>📚</span> Story Time</button>
            </div>

            <div class="custom-entry">
                <h3 style="color:var(--dark);margin-bottom:20px;">📝 Custom Entry</h3>
                <form id="customForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Child</label>
                            <select class="form-select" id="childSelect">
                                <option value="Lexie">Lexie</option>
                                <option value="Abby">Abby</option>
                                <option value="Both">Both</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Activity</label>
                            <input type="text" class="form-input" id="activityInput" placeholder="e.g., Snack, Bath, Medicine">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duration (minutes)</label>
                            <input type="number" class="form-input" id="durationInput" placeholder="Optional" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="notesInput" placeholder="Any additional details..."></textarea>
                    </div>
                    <button type="submit" class="submit-btn" id="submitBtn"><span>➕</span> Add Entry</button>
                </form>
            </div>
        </div>

        <!-- Current Status -->
        <div class="current-status">
            <div class="section-header">
                <h2 class="section-title">👀 Current Status</h2>
                <div class="last-update-badge"><span>⏱️</span><span id="statusUpdateTime">Just now</span></div>
            </div>
            <div class="baby-cards">
                <div class="baby-card">
                    <div class="baby-header">
                        <h3 class="baby-name"><span class="baby-emoji">👶</span>Lexie</h3>
                        <span class="baby-status">All Good 💚</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card" onclick="playSound('eat')"><div class="stat-icon">🍼</div><div class="stat-label">Last Fed</div><div class="stat-value" id="lexie-feed-value">--</div><div class="stat-time" id="lexie-feed-time">--</div></div>
                        <div class="stat-card" onclick="playSound('sleep')"><div class="stat-icon">😴</div><div class="stat-label">Last Sleep</div><div class="stat-value" id="lexie-sleep-value">--</div><div class="stat-time" id="lexie-sleep-time">--</div></div>
                        <div class="stat-card" onclick="playSound('diaper')"><div class="stat-icon">💩</div><div class="stat-label">Last Diaper</div><div class="stat-value" id="lexie-diaper-value">--</div><div class="stat-time" id="lexie-diaper-time">--</div></div>
                    </div>
                </div>
                <div class="baby-card">
                    <div class="baby-header">
                        <h3 class="baby-name"><span class="baby-emoji">👧</span>Abby</h3>
                        <span class="baby-status">Happy 😊</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card" onclick="playSound('eat')"><div class="stat-icon">🍽️</div><div class="stat-label">Last Meal</div><div class="stat-value" id="abby-meal-value">--</div><div class="stat-time" id="abby-meal-time">--</div></div>
                        <div class="stat-card" onclick="playSound('sleep')"><div class="stat-icon">🛏️</div><div class="stat-label">Last Sleep</div><div class="stat-value" id="abby-sleep-value">--</div><div class="stat-time" id="abby-sleep-time">--</div></div>
                        <div class="stat-card" onclick="playSound('potty')"><div class="stat-icon">🚽</div><div class="stat-label">Last Potty</div><div class="stat-value" id="abby-potty-value">--</div><div class="stat-time" id="abby-potty-time">--</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="recent-activity">
            <div class="section-header">
                <h2 class="section-title">✨ Recent Activity</h2>
                <span style="color:#9ca3af;font-size:.9em;">Last 5 activities</span>
            </div>
            <div id="recentActivityList">
                <div class="empty-state"><div class="empty-state-icon">📝</div><p>No activities yet</p></div>
            </div>
        </div>

        <!-- Complete Log -->
        <div class="complete-log">
            <div class="section-header">
                <h2 class="section-title">📚 Complete Evening Log</h2>
                <button class="log-toggle" id="logToggle" onclick="toggleLog()"><span id="logToggleIcon">▶</span><span id="logToggleText">Show Full Log</span></button>
            </div>
            <div class="log-content" id="logContent">
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterLog('all', event)">All Activities</button>
                    <button class="filter-tab" onclick="filterLog('Lexie', event)">Lexie Only</button>
                    <button class="filter-tab" onclick="filterLog('Abby', event)">Abby Only</button>
                </div>
                <div id="logList">
                    <div class="empty-state"><div class="empty-state-icon">📂</div><p>No log entries yet</p></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mode Toggle -->
    <div class="mode-toggle">
        <button class="mode-btn" id="soundBtn" onclick="toggleSound()">🔊</button>
        <button class="mode-btn" id="adminBtn" onclick="toggleAdminMode()">👨‍💼</button>
        <button class="mode-btn" onclick="refreshData()">🔄</button>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span class="notification-icon">✅</span>
        <span class="notification-text" id="notificationText">Entry added successfully!</span>
    </div>

    <script>
        // ===== CONFIG =====
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzg2bu4zQIxXo5Pwk2qk1VQ2n3Gp3n_o3IyORhFFnji5J2n93KQo32D9W2fbbJaP5CzjQ/exec';

        // ===== STATE =====
        let activities = [];
        let soundEnabled = true;
        let adminMode = false;
        let logExpanded = false;
        let currentFilter = 'all';
        let isLoading = false;
        let isRefreshing = false;
        let autoRefreshId = null;
        let audioCtx = null;

        // ===== UTIL =====
        const sleep = (ms) => new Promise(res => setTimeout(res, ms));
        function escapeHtml(s){ return (s==null?'':String(s)).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
        const nowAmPm = (d=new Date()) => d.toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit',hour12:true});

        // ---- CORS-safe API helper: ensure NO preflight ----
        async function callApi(action, payload = null, { method = 'GET', timeout = 10000, retries = 1 } = {}) {
            if (!navigator.onLine) { const err = new Error('OFFLINE'); err.code='OFFLINE'; throw err; }
            const controller = new AbortController();
            const url = `${GOOGLE_SCRIPT_URL}?action=${encodeURIComponent(action)}&t=${Date.now()}`;
            const options = { method, cache:'no-store', signal: controller.signal };
            if (method === 'POST') {
                // IMPORTANT: Exactly 'text/plain' (no charset) so the browser doesn't preflight.
                options.headers = { 'Content-Type': 'text/plain' };
                options.body = JSON.stringify(payload || {});
            }
            const timer = setTimeout(() => controller.abort(), timeout);
            try {
                const res = await fetch(url, options);
                if (!res.ok) throw new Error(`HTTP_${res.status}`);
                // Robust JSON parse with fallback logging
                const text = await res.text();
                try { return JSON.parse(text); }
                catch (e) { console.error('Non-JSON response:', text.slice(0,200)); throw new Error('BAD_JSON'); }
            } catch (err) {
                if (retries > 0) {
                    await sleep(400);
                    return callApi(action, payload, { method, timeout, retries: retries - 1 });
                }
                throw err;
            } finally {
                clearTimeout(timer);
            }
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', () => {
            updateClock();
            setInterval(updateClock, 1000);

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true') toggleAdminMode();

            startAutoRefresh();

            const form = document.getElementById('customForm');
            if (form) form.addEventListener('submit', (e) => { e.preventDefault(); addCustomEntry(); });

            document.addEventListener('visibilitychange', () => { if (document.hidden) stopAutoRefresh(); else startAutoRefresh(); });
        });

        function startAutoRefresh(){ refreshData(); stopAutoRefresh(); autoRefreshId = setInterval(()=>{ if (!adminMode) refreshData(); }, 10000); }
        function stopAutoRefresh(){ if (autoRefreshId) clearInterval(autoRefreshId); autoRefreshId = null; }
        function updateClock(){ const el=document.getElementById('currentTime'); if (el) el.textContent = nowAmPm(); }

        function ensureAudio(){ if (!audioCtx){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch{} } return audioCtx; }
        function playSound(type){
            if (!soundEnabled || !ensureAudio()) return;
            const ctx = audioCtx, osc = ctx.createOscillator(), gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            switch(type){
                case 'eat': osc.frequency.setValueAtTime(523.25,ctx.currentTime); osc.frequency.setValueAtTime(659.25,ctx.currentTime+.1); osc.frequency.setValueAtTime(783.99,ctx.currentTime+.2); break;
                case 'sleep': osc.frequency.setValueAtTime(261.63,ctx.currentTime); osc.frequency.setValueAtTime(329.63,ctx.currentTime+.15); osc.frequency.setValueAtTime(196.00,ctx.currentTime+.3); break;
                case 'diaper':
                case 'potty': osc.frequency.setValueAtTime(146.83,ctx.currentTime); osc.frequency.setValueAtTime(110.00,ctx.currentTime+.1); osc.frequency.setValueAtTime(146.83,ctx.currentTime+.2); break;
                case 'success': osc.frequency.setValueAtTime(523.25,ctx.currentTime); osc.frequency.setValueAtTime(659.25,ctx.currentTime+.05); osc.frequency.setValueAtTime(783.99,ctx.currentTime+.1); osc.frequency.setValueAtTime(1046.50,ctx.currentTime+.15); break;
                case 'toggle': osc.frequency.setValueAtTime(440.00,ctx.currentTime); osc.frequency.setValueAtTime(880.00,ctx.currentTime+.1); break;
                default: osc.frequency.setValueAtTime(440.00,ctx.currentTime);
            }
            gain.gain.setValueAtTime(0.3,ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+.5);
            osc.start(ctx.currentTime); osc.stop(ctx.currentTime+.5);
        }

        function toggleAdminMode(){
            adminMode = !adminMode;
            const panel = document.getElementById('controlPanel');
            const btn = document.getElementById('adminBtn');
            if (adminMode){ panel?.classList.add('admin-mode'); btn?.classList.add('active'); showNotification('Admin mode activated! 🎮'); stopAutoRefresh(); }
            else { panel?.classList.remove('admin-mode'); btn?.classList.remove('active'); showNotification('Viewing mode activated 👀'); startAutoRefresh(); }
        }
        function toggleSound(){ soundEnabled = !soundEnabled; const b=document.getElementById('soundBtn'); if (b) b.textContent = soundEnabled ? '🔊' : '🔇'; if (soundEnabled) playSound('toggle'); }
        function toggleLog(){
            logExpanded = !logExpanded;
            const logContent = document.getElementById('logContent'), toggleBtn = document.getElementById('logToggle'), icon = document.getElementById('logToggleIcon'), text = document.getElementById('logToggleText');
            if (logExpanded){ logContent?.classList.add('expanded'); toggleBtn?.classList.add('expanded'); if (icon) icon.textContent='▼'; if (text) text.textContent='Hide Full Log'; }
            else { logContent?.classList.remove('expanded'); toggleBtn?.classList.remove('expanded'); if (icon) icon.textContent='▶'; if (text) text.textContent='Show Full Log'; }
        }

        function showNotification(message){
            const el=document.getElementById('notification'), text=document.getElementById('notificationText');
            if (!el || !text) return;
            text.textContent = message; el.classList.add('show'); playSound('success');
            setTimeout(()=>el.classList.remove('show'), 3000);
        }

        async function quickAdd(child, activity, emoji){
            if (isLoading) return;
            document.querySelectorAll('.quick-btn').forEach(b=>b.disabled=true);
            const entry = { timestamp:new Date().toISOString(), child, activity, emoji, duration:null, notes:null };
            isLoading = true;
            try{
                const result = await callApi('add', entry, { method:'POST', retries:1 });
                if (result?.success){ showNotification(`${emoji} ${child}: ${activity}!`); await refreshData(); }
                else { showNotification('⚠️ Failed to add activity. Please try again.'); console.error('Failed to add:', result); }
            }catch(err){
                console.error('Error adding activity:', err);
                showNotification(err.code === 'OFFLINE' ? '⚠️ You appear to be offline.' : '⚠️ Connection issue adding activity.');
            }finally{
                isLoading=false;
                document.querySelectorAll('.quick-btn').forEach(b=>b.disabled=false);
            }
        }

        async function addCustomEntry(){
            if (isLoading) return;
            const child = document.getElementById('childSelect').value;
            const activity = document.getElementById('activityInput').value.trim();
            const duration = document.getElementById('durationInput').value;
            const notes = document.getElementById('notesInput').value.trim();
            if (!activity){ showNotification('Please enter an activity! ⚠️'); return; }

            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerHTML = '<span class="loading-spinner"></span> Adding...';

            const entry = { timestamp:new Date().toISOString(), child, activity, emoji:getActivityEmoji(activity), duration: duration?parseInt(duration,10):null, notes: notes||null };

            isLoading = true;
            try{
                const result = await callApi('add', entry, { method:'POST', retries:1 });
                if (result?.success){
                    document.getElementById('activityInput').value=''; document.getElementById('durationInput').value=''; document.getElementById('notesInput').value='';
                    showNotification(`✅ ${child}: ${activity} added!`);
                    await refreshData();
                }else{
                    showNotification('⚠️ Failed to add activity. Please try again.');
                    console.error('Failed to add:', result);
                }
            }catch(err){
                console.error('Error adding activity:', err);
                showNotification(err.code === 'OFFLINE' ? '⚠️ You appear to be offline.' : '⚠️ Connection issue adding activity.');
            }finally{
                isLoading=false; btn.disabled=false; btn.innerHTML='<span>➕</span> Add Entry';
            }
        }

        function getActivityEmoji(activity){
            const a=(activity||'').toLowerCase();
            const map={
                'feed':'🍼','fed':'🍼','bottle':'🍼','nurse':'🤱',
                'eat':'🍽️','ate':'🍽️','meal':'🍽️','breakfast':'🥞','lunch':'🥪','dinner':'🍝',
                'snack':'🍪','fruit':'🍎','vegetable':'🥦',
                'sleep':'😴','sleeping':'😴','nap':'💤','rest':'🛏️','bedtime':'🌙',
                'diaper':'💩','poop':'💩','pee':'💧',
                'potty':'🚽','toilet':'🚽',
                'play':'🎮','playing':'🎮','toy':'🧸','game':'🎲',
                'story':'📚','book':'📖','read':'📚',
                'bath':'🛁','wash':'🧼','shower':'🚿',
                'walk':'🚶','stroll':'👣','outside':'🌳',
                'cry':'😭','fuss':'😫','upset':'😢',
                'laugh':'😂','smile':'😊','happy':'😄',
                'dance':'💃','music':'🎵','sing':'🎤',
                'medicine':'💊','vitamin':'💊','temperature':'🌡️',
                'hug':'🤗','kiss':'😘','cuddle':'🤱',
                'milestone':'🎉','achievement':'🏆','first':'⭐',
                'photo':'📸','picture':'📷',
                'video':'📹','call':'📞'
            };
            for (const k in map) if (a.includes(k)) return map[k];
            return '⭐';
        }

        async function refreshData(){
            if (isRefreshing) return; isRefreshing = true;
            try{
                if (activities.length === 0){
                    const c=document.getElementById('recentActivityList');
                    if (c) c.innerHTML = `<div class="empty-state"><div class="empty-state-icon">⏳</div><p>Loading activities...</p></div>`;
                }
                const result = await callApi('get', null, { method:'GET', timeout:12000, retries:1 });
                if (result?.success){
                    activities = Array.isArray(result.activities) ? result.activities.slice() : [];
                    activities.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));

                    const last = document.getElementById('lastUpdate'); if (last) last.textContent = nowAmPm();

                    const badge = document.getElementById('statusUpdateTime');
                    if (badge){
                        if (activities.length){
                            const lastTs = new Date(activities[0].timestamp);
                            const diffMin = Math.floor((Date.now() - lastTs.getTime())/60000);
                            badge.textContent = diffMin < 1 ? 'Just now' : (diffMin < 60 ? `${diffMin} min ago` : `${Math.floor(diffMin/60)}h ago`);
                        } else badge.textContent = 'No updates yet';
                    }

                    updateBabyStats(); updateRecentActivities(); updateFullLog();
                }else{
                    console.error('Failed to fetch data:', result);
                    showNotification('⚠️ Unable to refresh data');
                }
            }catch(err){
                console.error('Error fetching data:', err);
                if (activities.length === 0){
                    const c=document.getElementById('recentActivityList');
                    if (c) c.innerHTML = `<div class="empty-state"><div class="empty-state-icon">⚠️</div><p>Unable to load activities</p><p style="font-size:.9em;margin-top:10px;">${navigator.onLine ? 'Server not responding' : 'Please check your connection'}</p></div>`;
                }
            }finally{ isRefreshing = false; }
        }

        function updateBabyStats(){
            const latest = { lexie:{feed:null,sleep:null,diaper:null}, abby:{meal:null,sleep:null,potty:null} };
            for (const a of activities){
                const t = new Date(a.timestamp);
                const txt = (a.activity||'').toLowerCase();
                if (a.child==='Lexie'||a.child==='Both'){
                    if (!latest.lexie.feed  && (txt.includes('feed')||txt.includes('fed')||txt.includes('bottle'))) latest.lexie.feed=t;
                    if (!latest.lexie.sleep && (txt.includes('sleep')||txt.includes('nap'))) latest.lexie.sleep=t;
                    if (!latest.lexie.diaper&& (txt.includes('diaper')||txt.includes('changed'))) latest.lexie.diaper=t;
                }
                if (a.child==='Abby'||a.child==='Both'){
                    if (!latest.abby.meal  && (txt.includes('eat')||txt.includes('ate')||txt.includes('meal')||txt.includes('snack'))) latest.abby.meal=t;
                    if (!latest.abby.sleep && (txt.includes('sleep')||txt.includes('nap'))) latest.abby.sleep=t;
                    if (!latest.abby.potty && (txt.includes('potty')||txt.includes('toilet'))) latest.abby.potty=t;
                }
            }
            updateStatDisplay('lexie-feed', latest.lexie.feed);
            updateStatDisplay('lexie-sleep', latest.lexie.sleep);
            updateStatDisplay('lexie-diaper', latest.lexie.diaper);
            updateStatDisplay('abby-meal', latest.abby.meal);
            updateStatDisplay('abby-sleep', latest.abby.sleep);
            updateStatDisplay('abby-potty', latest.abby.potty);
        }
        function updateStatDisplay(id, time){
            const v=document.getElementById(id+'-value'), tEl=document.getElementById(id+'-time');
            if (!v || !tEl) return;
            if (time){
                const diff = Math.floor((Date.now() - time.getTime())/60000);
                v.textContent = diff < 60 ? `${diff}m ago` : `${Math.floor(diff/60)}h ${diff%60}m ago`;
                tEl.textContent = nowAmPm(time);
            } else { v.textContent='--'; tEl.textContent='--'; }
        }

        function updateRecentActivities(){
            const c=document.getElementById('recentActivityList');
            if (!c) return;
            const recent = activities.slice(0,5);
            if (!recent.length){ c.innerHTML = `<div class="empty-state"><div class="empty-state-icon">📝</div><p>No activities yet</p></div>`; return; }
            c.innerHTML = recent.map(a=>{
                const time=new Date(a.timestamp);
                return `<div class="activity-item">
                    <div class="activity-icon">${escapeHtml(a.emoji||'⭐')}</div>
                    <div class="activity-details">
                        <div class="activity-child">${escapeHtml(a.child||'')}</div>
                        <div class="activity-text">${escapeHtml(a.activity||'')}${a.duration?` (${Number(a.duration)} min)`:''}</div>
                    </div>
                    <div class="activity-time">${nowAmPm(time)}</div>
                </div>`;
            }).join('');
        }

        function updateFullLog(){ filterLog(currentFilter); }
        function filterLog(filter, evt){
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(b=>b.classList.remove('active'));
            if (evt && evt.target) evt.target.classList.add('active');
            let list = activities;
            if (filter !== 'all') list = activities.filter(a => a.child===filter || a.child==='Both');
            const c = document.getElementById('logList');
            if (!c) return;
            if (!list.length){
                c.innerHTML = `<div class="empty-state"><div class="empty-state-icon">📂</div><p>No ${filter==='all'?'':escapeHtml(filter)+' '}activities yet</p></div>`;
                return;
            }
            c.innerHTML = list.map(a=>{
                const time=new Date(a.timestamp);
                const notes=a.notes?`<div class="log-notes">${escapeHtml(a.notes)}</div>`:'';
                const dur=a.duration?`<span class="log-duration">⏱️ ${Number(a.duration)} minutes</span>`:'';
                return `<div class="log-item">
                    <div class="log-icon">${escapeHtml(a.emoji||'⭐')}</div>
                    <div class="log-details">
                        <div class="log-header">
                            <span class="log-child">${escapeHtml(a.child)} - ${escapeHtml(a.activity||'')}</span>
                            <span class="log-time">${nowAmPm(time)}</span>
                        </div>
                        ${notes}${dur}
                    </div>
                </div>`;
            }).join('');
        }

        // Expose some functions to global for onclicks
        window.quickAdd = quickAdd;
        window.toggleAdminMode = toggleAdminMode;
        window.toggleSound = toggleSound;
        window.toggleLog = toggleLog;
        window.refreshData = refreshData;
    </script>
</body>
</html>
