<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lexie & Abby Live Tracker ‚ú®</title>
  <style>
    /* (styles unchanged from your last version I sent) */
    /* ... keep your existing CSS exactly as before ... */
  </style>
</head>
<body>
  <!-- (markup unchanged from your last version I sent) -->
  <!-- ... keep your existing HTML exactly as before ... -->

  <!-- Notification -->
  <div class="notification" id="notification">
    <span class="notification-icon">‚úÖ</span>
    <span class="notification-text" id="notificationText">Entry added successfully!</span>
  </div>

  <script>
    // ===== CONFIG =====
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzg2bu4zQIxXo5Pwk2qk1VQ2n3Gp3n_o3IyORhFFnji5J2n93KQo32D9W2fbbJaP5CzjQ/exec';

    // ===== STATE =====
    let activities = [];
    let soundEnabled = true;
    let adminMode = false;
    let logExpanded = false;
    let currentFilter = 'all';
    let isLoading = false;
    let isRefreshing = false;
    let autoRefreshId = null;
    let audioCtx = null;

    // ===== UTIL =====
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    function escapeHtml(s){ return (s==null?'':String(s)).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    const nowAmPm = (d=new Date()) => d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});

    // ---- CORS-safe API helper: no preflight ----
    async function callApi(action, payload = null, { method = 'GET', timeout = 10000, retries = 1 } = {}) {
      if (!navigator.onLine) {
        const err = new Error('OFFLINE');
        err.code = 'OFFLINE';
        throw err;
      }
      const controller = new AbortController();
      const url = `${GOOGLE_SCRIPT_URL}?action=${encodeURIComponent(action)}&t=${Date.now()}`;
      const options = {
        method,
        cache: 'no-store',
        signal: controller.signal,
        // DO NOT set any non-simple headers that cause preflight.
      };
      if (method === 'POST') {
        options.headers = { 'Content-Type': 'text/plain;charset=utf-8' }; // simple request (no preflight)
        options.body = JSON.stringify(payload || {});
      }

      const timer = setTimeout(() => controller.abort(), timeout);
      try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error(`HTTP_${res.status}`);
        return await res.json();
      } catch (err) {
        if (retries > 0) {
          await sleep(400);
          return callApi(action, payload, { method, timeout, retries: retries - 1 });
        }
        throw err;
      } finally {
        clearTimeout(timer);
      }
    }

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', () => {
      updateClock();
      setInterval(updateClock, 1000);

      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('admin') === 'true') toggleAdminMode();

      startAutoRefresh();

      const form = document.getElementById('customForm');
      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          addCustomEntry();
        });
      }

      document.addEventListener('visibilitychange', () => {
        if (document.hidden) stopAutoRefresh();
        else startAutoRefresh();
      });
    });

    function startAutoRefresh() {
      refreshData();
      stopAutoRefresh();
      autoRefreshId = setInterval(() => { if (!adminMode) refreshData(); }, 10000);
    }
    function stopAutoRefresh() { if (autoRefreshId) clearInterval(autoRefreshId); autoRefreshId = null; }
    function updateClock(){ const el=document.getElementById('currentTime'); if (el) el.textContent = nowAmPm(); }

    function ensureAudio() {
      if (!audioCtx) {
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch {}
      }
      return audioCtx;
    }
    function playSound(type) {
      if (!soundEnabled || !ensureAudio()) return;
      const ctx = audioCtx, osc = ctx.createOscillator(), gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      switch(type){
        case 'eat':   osc.frequency.setValueAtTime(523.25,ctx.currentTime); osc.frequency.setValueAtTime(659.25,ctx.currentTime+.1); osc.frequency.setValueAtTime(783.99,ctx.currentTime+.2); break;
        case 'sleep': osc.frequency.setValueAtTime(261.63,ctx.currentTime); osc.frequency.setValueAtTime(329.63,ctx.currentTime+.15); osc.frequency.setValueAtTime(196.00,ctx.currentTime+.3); break;
        case 'diaper': case 'potty': osc.frequency.setValueAtTime(146.83,ctx.currentTime); osc.frequency.setValueAtTime(110.00,ctx.currentTime+.1); osc.frequency.setValueAtTime(146.83,ctx.currentTime+.2); break;
        case 'success': osc.frequency.setValueAtTime(523.25,ctx.currentTime); osc.frequency.setValueAtTime(659.25,ctx.currentTime+.05); osc.frequency.setValueAtTime(783.99,ctx.currentTime+.1); osc.frequency.setValueAtTime(1046.50,ctx.currentTime+.15); break;
        case 'toggle': osc.frequency.setValueAtTime(440.00,ctx.currentTime); osc.frequency.setValueAtTime(880.00,ctx.currentTime+.1); break;
        default: osc.frequency.setValueAtTime(440.00,ctx.currentTime);
      }
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.5);
    }

    function toggleAdminMode(){
      adminMode = !adminMode;
      const panel = document.getElementById('controlPanel');
      const btn = document.getElementById('adminBtn');
      if (panel && btn) {
        if (adminMode) { panel.classList.add('admin-mode'); btn.classList.add('active'); showNotification('Admin mode activated! üéÆ'); stopAutoRefresh(); }
        else { panel.classList.remove('admin-mode'); btn.classList.remove('active'); showNotification('Viewing mode activated üëÄ'); startAutoRefresh(); }
      }
    }
    function toggleSound(){ soundEnabled = !soundEnabled; const b=document.getElementById('soundBtn'); if (b) b.textContent = soundEnabled ? 'üîä' : 'üîá'; if (soundEnabled) playSound('toggle'); }

    function toggleLog(){
      logExpanded=!logExpanded;
      const logContent=document.getElementById('logContent'), toggleBtn=document.getElementById('logToggle'), icon=document.getElementById('logToggleIcon'), text=document.getElementById('logToggleText');
      if (logContent && toggleBtn && icon && text){
        if (logExpanded){ logContent.classList.add('expanded'); toggleBtn.classList.add('expanded'); icon.textContent='‚ñº'; text.textContent='Hide Full Log'; }
        else { logContent.classList.remove('expanded'); toggleBtn.classList.remove('expanded'); icon.textContent='‚ñ∂'; text.textContent='Show Full Log'; }
      }
    }

    function showNotification(message){
      const el=document.getElementById('notification'), text=document.getElementById('notificationText');
      if (!el || !text) return;
      text.textContent = message; el.classList.add('show'); playSound('success');
      setTimeout(()=> el.classList.remove('show'), 3000);
    }

    async function quickAdd(child, activity, emoji){
      if (isLoading) return;
      document.querySelectorAll('.quick-btn').forEach(b=>b.disabled=true);
      const entry = { timestamp:new Date().toISOString(), child, activity, emoji, duration:null, notes:null };
      isLoading = true;
      try{
        const result = await callApi('add', entry, { method:'POST', retries:1 });
        if (result && result.success){ showNotification(`${emoji} ${child}: ${activity}!`); await refreshData(); }
        else { showNotification('‚ö†Ô∏è Failed to add activity. Please try again.'); console.error('Failed to add:', result); }
      }catch(err){
        console.error('Error adding activity:', err);
        showNotification(err.code === 'OFFLINE' ? '‚ö†Ô∏è You appear to be offline.' : '‚ö†Ô∏è Connection issue adding activity.');
      }finally{
        isLoading=false;
        document.querySelectorAll('.quick-btn').forEach(b=>b.disabled=false);
      }
    }

    async function addCustomEntry(){
      if (isLoading) return;
      const child = document.getElementById('childSelect').value;
      const activity = document.getElementById('activityInput').value.trim();
      const duration = document.getElementById('durationInput').value;
      const notes = document.getElementById('notesInput').value.trim();
      if (!activity){ showNotification('Please enter an activity! ‚ö†Ô∏è'); return; }

      const btn = document.getElementById('submitBtn');
      btn.disabled = true; btn.innerHTML = '<span class="loading-spinner"></span> Adding...';

      const entry = {
        timestamp: new Date().toISOString(),
        child,
        activity,
        emoji: getActivityEmoji(activity),
        duration: duration ? parseInt(duration,10) : null,
        notes: notes || null
      };

      isLoading = true;
      try{
        const result = await callApi('add', entry, { method:'POST', retries:1 });
        if (result && result.success){
          document.getElementById('activityInput').value='';
          document.getElementById('durationInput').value='';
          document.getElementById('notesInput').value='';
          showNotification(`‚úÖ ${child}: ${activity} added!`);
          await refreshData();
        }else{
          showNotification('‚ö†Ô∏è Failed to add activity. Please try again.');
          console.error('Failed to add:', result);
        }
      }catch(err){
        console.error('Error adding activity:', err);
        showNotification(err.code === 'OFFLINE' ? '‚ö†Ô∏è You appear to be offline.' : '‚ö†Ô∏è Connection issue adding activity.');
      }finally{
        isLoading=false; btn.disabled=false; btn.innerHTML='<span>‚ûï</span> Add Entry';
      }
    }

    function getActivityEmoji(activity){
      const a=(activity||'').toLowerCase();
      const map={
        'feed':'üçº','fed':'üçº','bottle':'üçº','nurse':'ü§±',
        'eat':'üçΩÔ∏è','ate':'üçΩÔ∏è','meal':'üçΩÔ∏è','breakfast':'ü•û','lunch':'ü•™','dinner':'üçù',
        'snack':'üç™','fruit':'üçé','vegetable':'ü•¶',
        'sleep':'üò¥','sleeping':'üò¥','nap':'üí§','rest':'üõèÔ∏è','bedtime':'üåô',
        'diaper':'üí©','poop':'üí©','pee':'üíß',
        'potty':'üöΩ','toilet':'üöΩ',
        'play':'üéÆ','playing':'üéÆ','toy':'üß∏','game':'üé≤',
        'story':'üìö','book':'üìñ','read':'üìö',
        'bath':'üõÅ','wash':'üßº','shower':'üöø',
        'walk':'üö∂','stroll':'üë£','outside':'üå≥',
        'cry':'üò≠','fuss':'üò´','upset':'üò¢',
        'laugh':'üòÇ','smile':'üòä','happy':'üòÑ',
        'dance':'üíÉ','music':'üéµ','sing':'üé§',
        'medicine':'üíä','vitamin':'üíä','temperature':'üå°Ô∏è',
        'hug':'ü§ó','kiss':'üòò','cuddle':'ü§±',
        'milestone':'üéâ','achievement':'üèÜ','first':'‚≠ê',
        'photo':'üì∏','picture':'üì∑',
        'video':'üìπ','call':'üìû'
      };
      for (const k in map) if (a.includes(k)) return map[k];
      return '‚≠ê';
    }

    async function refreshData(){
      if (isRefreshing) return; isRefreshing = true;
      try{
        if (activities.length === 0){
          const c=document.getElementById('recentActivityList');
          if (c) c.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚è≥</div><p>Loading activities...</p></div>`;
        }
        const result = await callApi('get', null, { method:'GET', timeout:12000, retries:1 });
        if (result && result.success){
          activities = Array.isArray(result.activities) ? result.activities.slice() : [];
          activities.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));

          const last = document.getElementById('lastUpdate');
          if (last) last.textContent = nowAmPm();

          const badge = document.getElementById('statusUpdateTime');
          if (badge){
            if (activities.length){
              const lastTs = new Date(activities[0].timestamp);
              const diffMin = Math.floor((Date.now() - lastTs.getTime())/60000);
              badge.textContent = diffMin < 1 ? 'Just now' : (diffMin < 60 ? `${diffMin} min ago` : `${Math.floor(diffMin/60)}h ago`);
            } else badge.textContent = 'No updates yet';
          }

          updateBabyStats(); updateRecentActivities(); updateFullLog();
        }else{
          console.error('Failed to fetch data:', result);
          showNotification('‚ö†Ô∏è Unable to refresh data');
        }
      }catch(err){
        console.error('Error fetching data:', err);
        if (activities.length === 0){
          const c=document.getElementById('recentActivityList');
          if (c) c.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Unable to load activities</p><p style="font-size:.9em;margin-top:10px;">${navigator.onLine ? 'Server not responding' : 'Please check your connection'}</p></div>`;
        }
      }finally{
        isRefreshing = false;
      }
    }

    function updateBabyStats(){
      const latest = { lexie:{feed:null,sleep:null,diaper:null}, abby:{meal:null,sleep:null,potty:null} };
      for (const a of activities){
        const t = new Date(a.timestamp);
        const txt = (a.activity||'').toLowerCase();
        if (a.child==='Lexie'||a.child==='Both'){
          if (!latest.lexie.feed  && (txt.includes('feed')||txt.includes('fed')||txt.includes('bottle'))) latest.lexie.feed=t;
          if (!latest.lexie.sleep && (txt.includes('sleep')||txt.includes('nap'))) latest.lexie.sleep=t;
          if (!latest.lexie.diaper&& (txt.includes('diaper')||txt.includes('changed'))) latest.lexie.diaper=t;
        }
        if (a.child==='Abby'||a.child==='Both'){
          if (!latest.abby.meal  && (txt.includes('eat')||txt.includes('ate')||txt.includes('meal')||txt.includes('snack'))) latest.abby.meal=t;
          if (!latest.abby.sleep && (txt.includes('sleep')||txt.includes('nap'))) latest.abby.sleep=t;
          if (!latest.abby.potty && (txt.includes('potty')||txt.includes('toilet'))) latest.abby.potty=t;
        }
      }
      updateStatDisplay('lexie-feed', latest.lexie.feed);
      updateStatDisplay('lexie-sleep', latest.lexie.sleep);
      updateStatDisplay('lexie-diaper', latest.lexie.diaper);
      updateStatDisplay('abby-meal', latest.abby.meal);
      updateStatDisplay('abby-sleep', latest.abby.sleep);
      updateStatDisplay('abby-potty', latest.abby.potty);
    }
    function updateStatDisplay(id, time){
      const v=document.getElementById(id+'-value'), tEl=document.getElementById(id+'-time');
      if (!v || !tEl) return;
      if (time){
        const diff = Math.floor((Date.now() - time.getTime())/60000);
        v.textContent = diff < 60 ? `${diff}m ago` : `${Math.floor(diff/60)}h ${diff%60}m ago`;
        tEl.textContent = nowAmPm(time);
      } else { v.textContent='--'; tEl.textContent='--'; }
    }

    function updateRecentActivities(){
      const c=document.getElementById('recentActivityList');
      if (!c) return;
      const recent = activities.slice(0,5);
      if (!recent.length){ c.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìù</div><p>No activities yet</p></div>`; return; }
      c.innerHTML = recent.map(a=>{
        const time = new Date(a.timestamp);
        return `<div class="activity-item">
          <div class="activity-icon">${escapeHtml(a.emoji||'‚≠ê')}</div>
          <div class="activity-details">
            <div class="activity-child">${escapeHtml(a.child||'')}</div>
            <div class="activity-text">${escapeHtml(a.activity||'')}${a.duration?` (${Number(a.duration)} min)`:''}</div>
          </div>
          <div class="activity-time">${nowAmPm(time)}</div>
        </div>`;
      }).join('');
    }

    function updateFullLog(){ filterLog(currentFilter); }
    function filterLog(filter, evt){
      currentFilter = filter;
      document.querySelectorAll('.filter-tab').forEach(b=>b.classList.remove('active'));
      if (evt && evt.target) evt.target.classList.add('active');

      let list = activities;
      if (filter !== 'all') list = activities.filter(a => a.child===filter || a.child==='Both');

      const c = document.getElementById('logList');
      if (!c) return;
      if (!list.length){
        c.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìÇ</div><p>No ${filter==='all'?'':escapeHtml(filter)+' '}activities yet</p></div>`;
        return;
      }
      c.innerHTML = list.map(a=>{
        const time=new Date(a.timestamp);
        const notes=a.notes?`<div class="log-notes">${escapeHtml(a.notes)}</div>`:'';
        const dur=a.duration?`<span class="log-duration">‚è±Ô∏è ${Number(a.duration)} minutes</span>`:'';
        return `<div class="log-item">
          <div class="log-icon">${escapeHtml(a.emoji||'‚≠ê')}</div>
          <div class="log-details">
            <div class="log-header">
              <span class="log-child">${escapeHtml(a.child)} - ${escapeHtml(a.activity||'')}</span>
              <span class="log-time">${nowAmPm(time)}</span>
            </div>
            ${notes}${dur}
          </div>
        </div>`;
      }).join('');
    }

    // Expose buttons already in your markup (unchanged)
    window.toggleSound = toggleSound;
    window.toggleAdminMode = toggleAdminMode;
    window.toggleLog = toggleLog;
    window.quickAdd = quickAdd;
    window.refreshData = refreshData;
    window.playSound = playSound;
    window.filterLog = filterLog;
  </script>
</body>
</html>
